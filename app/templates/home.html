{% extends 'base.html' %}
{% block title %}Home{% endblock %}

{% block content %}
  {# Flash messages #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, message in messages %}
          {% if category == 'success' %}
            <div id="flash-messages" class="alert alert-success">{{ message }}</div>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <section class="d-flex align-items-center custom-container custom-section bg-light"
    style="
      min-height: 60vh;
      background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.7)),
                        url('{{ url_for('static', filename='uploads/booksinmountain.jpeg') }}');
      background-size: cover;
      background-position:bottom;
      background-repeat: no-repeat;
    ">
    <div class="container text-center">
      <h1 class="display-4 mb-4 text-white">
        {% if current_user.is_authenticated %}
          Hallo {{ current_user.username or current_user.business_name }},
        {% else %}
           Grootste Antiqua(riaat) van België
        {% endif %}
      </h1>

      

      <!-- Zoekformulier -->
      <form id="searchForm" action="{{ url_for('main.search') }}" method="GET" class="mb-4">
        <div class="row g-2 justify-content-center">
          <div class="col-12 col-md-8">
            <input type="text" name="query" class="form-control form-control-lg rounded-0"
                   placeholder="Zoek waardevolle Boeken, Posters, Postkaarten,..." required>
          </div>
          <div class="col-12 col-md-auto">
            <button class="btn btn-lg w-100 rounded-0"
                    style="background-color: #060680; color: white;border: none !important; box-shadow: none; outline: none;"
                    type="submit">
              Zoek
            </button>
          </div>
        </div>
      </form>
    </div>
  </section>


    <section class="verkoop-sectie">
      


  <section class="container-section">

  <!-- Postkaarten -->
  <a href="{{ url_for('main.filter_items', category='postcards') }}" class="oude-postkaarten text-decoration-none text-white">
    <div>
      <h1>Postkaarten</h1>
    </div>
  </a>

  <!-- Posters -->
  <a href="{{ url_for('main.filter_items', category='posters') }}" class="oude-posters text-decoration-none text-white">
    <div>
      <h1>Posters</h1>
    </div>
  </a>

  <!-- Boeken -->
  <a href="{{ url_for('main.filter_items', category='books') }}" class="derde-item text-decoration-none text-white">
    <div>
      <h1>Boeken</h1>
    </div>
  </a>

  <!-- Kunst (volledige breedte) -->
  <a href="{{ url_for('main.filter_items', category='art') }}" class="kunst-item text-decoration-none text-white w-100 d-block" style="background:#222; margin-top:1rem;">
    <div style="width:100%;text-align:center;padding:2rem 0;">
      <h1 style="font-size:2.5rem;">Kunst</h1>
    </div>
  </a>

  </section>

  

  <section class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">(Antiqua)riaten op de kaart</h2>
      <button class="btn btn-primary rounded-0" onclick="zoomToUserLocation()"
         style="background-color: #000066; font-size: large; color: white; border: none;">
        Zoek jou locatie
      </button>
    </div>
    <div id="map" style="height: 500px;"></div>
    <div class="d-flex justify-content-center mt-4">
  <a href="{{ url_for('main.dashboard') }}" class="btn btn-success btn-lg px-5 py-3 fw-bold"
     style="background-color: #060680; color: white;  box-shadow: none; outline: none;">
        <i class="bi bi-gem me-2"></i> Wordt gratis klant
      </a>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    let map;

    document.addEventListener('DOMContentLoaded', () => {
      map = L.map('map').setView([51.05, 3.73], 8);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Voeg verkoper-markers toe
      {% for user in verkopers %}
        {% if user.latitude and user.longitude %}
          L.marker([{{ user.latitude }}, {{ user.longitude }}]).addTo(map)
             .bindPopup(`
                <div style="text-align:center;">
                  {% if user.image_file %}
                    <a href="{{ url_for('main.public_seller_profile', business_name=user.business_name) }}" target="_blank">
                      <img src="{{ url_for('static', filename='profile_pics/' + user.image_file) }}"
                           alt="Profielfoto {{ user.business_name }}"
                           style="width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:8px;">
                    </a><br>
                  {% endif %}
                  <a href="{{ url_for('main.public_seller_profile', business_name=user.business_name) }}"
                     target="_blank" style="font-weight:bold;">
                    {{ user.business_name or 'Verkoper' }}
                  </a>
                </div>
             `);
        {% endif %}
      {% endfor %}

      // Zoekformulier loader (optioneel, als je dat gebruikt)
      const form = document.getElementById('searchForm');
      const loader = document.getElementById('loader');
      if (form && loader) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          loader.style.display = 'inline-block';
          setTimeout(() => {
            form.submit();
          }, 500);
        });
      }

      window.addEventListener('pageshow', event => {
        if (event.persisted && loader) {
          loader.style.display = 'none';
        }
      });
    });

    function zoomToUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;
          map.setView([latitude, longitude], 11);
          L.marker([latitude, longitude], { title: "Je locatie" })
            .addTo(map)
            .bindPopup("📍 Je bent hier")
            .openPopup();
        }, error => {
          alert("Locatie kon niet worden opgehaald.");
        });
      } else {
        alert("Geolocatie wordt niet ondersteund door je browser.");
      }
    }
  </script>
{% endblock %}
