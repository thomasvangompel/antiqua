{% extends "base.html" %}
{% block title %}Profiel{% endblock %}
{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="mt-3 container">
      {% for category, message in messages %}
        <div id="flash-messages" class="alert alert-{{category}}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="container mt-4">
    <h2>Jouw Profiel</h2>

    {% if current_user.account_type == 'pro' %}
        <label for="image-upload" style="cursor:pointer;">
        {% if current_user.image_file == "default.png" or current_user.image_file == "default.jpg" %}
            <span class="bi bi-person-circle profile-pic rounded-circle mb-3" style="font-size: 6rem;" id="profile-picture"></span>
        {% else %}
            <img src="{{ url_for('static', filename='profile_pics/' + current_user.image_file) }}" alt="Profielfoto" class="profile-pic rounded-circle mb-3" id="profile-picture" style="cursor: pointer; width: 150px; height: 150px; object-fit: cover;">
        {% endif %}
        </label>
    {% endif %}

    <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <input type="file" id="image-upload" name="image" style="display:none;" accept="image/*" onchange="previewProfilePic(this)">

        <!-- Verborgen input gekoppeld aan profielfoto -->
        <div class="mb-3" style="display: none;">
            {{ form.image.label }}
            {{ form.image(class="form-control", id="image-upload") }}
        </div>

        <div class="mb-3">
            {{ form.username.label }} {{ form.username(class="form-control") }}
        </div>

        <div class="mb-3">
            {{ form.email.label }} {{ form.email(class="form-control") }}
        </div>

        <div class="mb-3 position-relative">
            {{ form.street.label }} {{ form.street(class="form-control", id="street") }}
            <span id="street-valid" class="position-absolute" style="right: 10px; top: 38px; display: none; color: green;">✔️</span>
        </div>

        <div class="mb-3 position-relative">
            {{ form.house_number.label }} {{ form.house_number(class="form-control", id="house_number") }}
            <span id="house-valid" class="position-absolute" style="right: 10px; top: 38px; display: none; color: green;">✔️</span>
        </div>

        <div class="mb-3 position-relative">
            {{ form.postal_code.label }} {{ form.postal_code(class="form-control", id="postal_code") }}
            <span id="postal-valid" class="position-absolute" style="right: 10px; top: 38px; display: none; color: green;">✔️</span>
        </div>

        <div class="mb-3 position-relative">
            {{ form.city.label }} {{ form.city(class="form-control", id="city") }}
            <span id="city-valid" class="position-absolute" style="right: 10px; top: 38px; display: none; color: green;">✔️</span>
        </div>
         {% if current_user.account_type == 'pro' %}
            <div class="mb-3 position-relative">
            {{ form.business_name.label }} {{ form.business_name(class="form-control", id="business_name") }}
            <span id="business-name-status" class="position-absolute" style="right: 10px; top: 38px; display: none;"></span>
             </div>
              <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="show_on_map" name="show_on_map"
                   {% if form.show_on_map.data %}checked{% endif %}>
            <label class="form-check-label" for="show_on_map">Toon mijn winkel op de kaart voor meer zichtbaarheid</label>
        </div>
         {% endif %}
        

       

        {{ form.submit(class="btn btn-primary") }}
    </form>
</div>

<!-- EXIF.js voor oriëntatieherstel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>

<script>
// Klik op profielfoto opent verborgen file input
document.getElementById('profile-picture').addEventListener('click', function () {
    document.getElementById('image-upload').click();
});

// Preview met oriëntatiecorrectie
document.getElementById('image-upload').addEventListener('change', function (event) {
    const file = event.target.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const img = new Image();
            img.onload = function () {
                EXIF.getData(img, function () {
                    const orientation = EXIF.getTag(this, 'Orientation');
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    let width = img.width;
                    let height = img.height;

                    if (orientation === 6 || orientation === 8) {
                        canvas.width = height;
                        canvas.height = width;
                    } else {
                        canvas.width = width;
                        canvas.height = height;
                    }

                    switch (orientation) {
                        case 2: // horizontal flip
                            ctx.translate(width, 0);
                            ctx.scale(-1, 1);
                            break;
                        case 3: // 180° rotate
                            ctx.translate(width, height);
                            ctx.rotate(Math.PI);
                            break;
                        case 4: // vertical flip
                            ctx.translate(0, height);
                            ctx.scale(1, -1);
                            break;
                        case 5: // vertical flip + 90 rotate
                            ctx.rotate(0.5 * Math.PI);
                            ctx.scale(1, -1);
                            break;
                        case 6: // 90° rotate
                            ctx.rotate(0.5 * Math.PI);
                            ctx.translate(0, -height);
                            break;
                        case 7: // horizontal flip + 90 rotate
                            ctx.rotate(0.5 * Math.PI);
                            ctx.translate(width, -height);
                            ctx.scale(-1, 1);
                            break;
                        case 8: // 270° rotate
                            ctx.rotate(-0.5 * Math.PI);
                            ctx.translate(-width, 0);
                            break;
                    }

                    ctx.drawImage(img, 0, 0);
                    document.getElementById('profile-picture').src = canvas.toDataURL('image/jpeg');
                });
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// Adresvalidatie
const straatInput = document.getElementById('street');
const huisnummerInput = document.getElementById('house_number');
const postcodeInput = document.getElementById('postal_code');
const stadInput = document.getElementById('city');

const streetValid = document.getElementById('street-valid');
const houseValid = document.getElementById('house-valid');
const postalValid = document.getElementById('postal-valid');
const cityValid = document.getElementById('city-valid');

function validateAddress() {
    const straat = straatInput.value.trim();
    const huisnummer = huisnummerInput.value.trim();
    const postcode = postcodeInput.value.trim();
    const stad = stadInput.value.trim();

    if (!straat || !huisnummer || !postcode || !stad) {
        hideAllChecks();
        return;
    }

    const fullAddress = `${straat} ${huisnummer}, ${postcode} ${stad}, België`;

    fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(fullAddress)}&countrycodes=be&limit=1&accept-language=nl`)
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                showAllChecks();
            } else {
                hideAllChecks();
            }
        })
        .catch(() => {
            hideAllChecks();
        });
}

function showAllChecks() {
    streetValid.style.display = 'inline';
    houseValid.style.display = 'inline';
    postalValid.style.display = 'inline';
    cityValid.style.display = 'inline';
}

function hideAllChecks() {
    streetValid.style.display = 'none';
    houseValid.style.display = 'none';
    postalValid.style.display = 'none';
    cityValid.style.display = 'none';
}

let debounceTimer;
function debounceValidate() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(validateAddress, 700);
}

straatInput.addEventListener('input', debounceValidate);
huisnummerInput.addEventListener('input', debounceValidate);
postcodeInput.addEventListener('input', debounceValidate);
stadInput.addEventListener('input', debounceValidate);

// Business name realtime check
const businessNameInput = document.getElementById('business_name');
const statusSpan = document.getElementById('business-name-status');

function checkBusinessName() {
    const name = businessNameInput.value.trim();
    if (!name) {
        statusSpan.style.display = 'none';
        return;
    }
    fetch(`/check_business_name?business_name=${encodeURIComponent(name)}`)
        .then(response => response.json())
        .then(data => {
            if (data.available) {
                statusSpan.style.color = 'green';
                statusSpan.textContent = '✔️';
                statusSpan.style.display = 'inline';
            } else {
                statusSpan.style.color = 'red';
                statusSpan.textContent = '❌';
                statusSpan.style.display = 'inline';
            }
        })
        .catch(() => {
            statusSpan.style.display = 'none';
        });
}

let debounceTimerBusiness;
businessNameInput.addEventListener('input', () => {
    clearTimeout(debounceTimerBusiness);
    debounceTimerBusiness = setTimeout(checkBusinessName, 500);
});
</script>

<script>
function previewProfilePic(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function (e) {
            var pic = document.getElementById('profile-picture');
            if (pic.tagName === 'IMG') {
                pic.src = e.target.result;
            } else {
                // Vervang icon door img
                var img = document.createElement('img');
                img.src = e.target.result;
                img.className = pic.className;
                img.id = 'profile-picture';
                img.style.cssText = pic.style.cssText;
                pic.parentNode.replaceChild(img, pic);
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
    setTimeout(function(){ input.form.submit(); }, 500);
}
</script>

{% endblock %}
